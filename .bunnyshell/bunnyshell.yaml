kind: Environment
name: DemoBooks-Integration
type: primary
environmentVariables:
    NEON_API_TOKEN: '<<BNS_SECRET>>'
    NEON_PROJECT_ID: bold-shadow-168128
    NEON_SOURCE_BRANCH_ID: br-frosty-mud-840365
    POSTGRES_DB: '<<BNS_SECRET>>'
    POSTGRES_PASSWORD: '<<BNS_SECRET>>'
    POSTGRES_USER: '<<BNS_SECRET>>'
components:
    -
        kind: Application
        name: backend
        gitRepo: 'https://github.com/dakar91/demo-books.git'
        gitBranch: neon-database
        gitApplicationPath: backend
        dockerCompose:
            build:
                context: ./backend
                dockerfile: Dockerfile
                target: prod
            environment:
                FRONTEND_URL: 'https://{{ components.frontend.ingress.hosts[0] }}'
                POSTGRES_HOST: '{{ components.neon-database.exported.DB_HOST }}'
            ports:
                - '3080:3080'
        hosts:
            -
                hostname: 'backend-{{ env.base_domain }}'
                path: /
                servicePort: 3080
    -
        kind: Application
        name: frontend
        gitRepo: 'https://github.com/dakar91/demo-books.git'
        gitBranch: neon-database
        gitApplicationPath: frontend
        dockerCompose:
            build:
                context: ./frontend
                dockerfile: Dockerfile
                args:
                    REACT_APP_BASE_API: 'https://{{ components.backend.ingress.hosts[0] }}'
                target: prod
            ports:
                - '8080:8080'
        hosts:
            -
                hostname: 'frontend-{{ env.base_domain }}'
                path: /
                servicePort: 8080
    -
        kind: GenericComponent
        name: neon-database
        runnerImage: 'bunnyshell/basic-runner-image:0.1.0'
        deploy:
            - 'curl -L -o create_database.sh https://raw.githubusercontent.com/bunnyshell/connectors/main/neon-database/scripts/create_database.sh'
            - '. create_database.sh'
            - |
                echo $DB_HOST
        destroy:
            - 'curl -L -o delete_database.sh https://raw.githubusercontent.com/bunnyshell/connectors/main/neon-database/scripts/delete_database.sh'
            - '. delete_database.sh'
        start:
            - 'echo "Start scripts are not needed. Neon has auto-idle and auto-start capabilities, so control from Bunnyshell is not needed."'
        stop:
            - 'echo "Stop scripts are not needed. Neon has auto-idle and auto-start capabilities, so control from Bunnyshell is not needed."'
        exportVariables:
            - DB_HOST
            - BRANCH_ID
        environment:
            API_TOKEN: '{{ env.vars.NEON_API_TOKEN }}'
            BRANCH_ID: '{{ components.neon-database.exported.BRANCH_ID }}'
            DB_HOST: '{{ components.neon-database.exported.DB_HOST }}'
            PROJECT_ID: '{{ env.vars.NEON_PROJECT_ID }}'
            SOURCE_BRANCH_ID: '{{ env.vars.NEON_SOURCE_BRANCH_ID }}'
            TARGET_BRANCH_NAME: 'bns-{{ env.unique}}'
volumes:
    -
        name: db-data
        size: 1Gi
        type: disk
